<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Secure Emoji Chat</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f8fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #4ecdc4;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }
    form {
      display: flex;
      padding: 1rem;
      border-top: 1px solid #ddd;
      background: white;
    }
    input[type="text"] {
      flex: 1;
      padding: 0.75rem;
      font-size: 1rem;
    }
    button {
      padding: 0.75rem 1rem;
      background: #4ecdc4;
      border: none;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .message {
      margin: 0.5rem 0;
      padding: 0.75rem;
      border-radius: 8px;
      max-width: 70%;
      background: #eee;
    }
    .message--mine {
      background: #4ecdc4;
      color: white;
      margin-left: auto;
    }
    .system-message {
      text-align: center;
      font-style: italic;
      color: gray;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <header>
    <h2>🔒 Secure Emoji Chat</h2>
    <div class="status">Connecting...</div>
  </header>
  <div class="messages"></div>
  <form>
    <input type="text" placeholder="Say something..." />
    <button>Send</button>
  </form>

  <template data-template="message">
    <div class="message">
      <div class="message__name" style="font-weight: bold;"></div>
      <div class="message__bubble"></div>
    </div>
  </template>

  <script>
    const emojiList = ['🐱','🐶','🐵','🐸','🐯','🐼','🐰','🐹','🐻','🐷'];
    const emoji = emojiList[Math.floor(Math.random() * emojiList.length)];
    let name = prompt("What's your name?") || "Anonymous";
    name = name.trim() || "Anonymous";

    const roomId = prompt("Room ID? (Leave blank for default)") || "global";
    const isHost = !location.hash.includes("joined");
    location.hash = roomId + (isHost ? '' : '#joined');

    let roomPasscode = '';
    let roomLocked = false;

    if (isHost) {
      roomPasscode = prompt("Set a passcode for this room:") || "";
      roomLocked = confirm("Lock the room to prevent new users?");
    }

    const drone = new ScaleDrone('yiS12Ts5RdNhebyM');
    const roomName = 'observable-' + roomId;
    let room, isConnected = false, connectedUsers = new Map();

    function broadcastState() {
      broadcastMessage({
        type: 'room_state',
        passcode: roomPasscode,
        locked: roomLocked
      });
    }

    function showStatus(msg) {
      const el = document.querySelector('.status');
      if (el) el.textContent = msg;
      document.title = `Chat (${msg})`;
    }

    function insertSystemMessage(msg) {
      const div = document.createElement('div');
      div.className = 'system-message';
      div.textContent = msg;
      document.querySelector('.messages').appendChild(div);
    }

    function scrollToBottom() {
      const messages = document.querySelector('.messages');
      messages.scrollTop = messages.scrollHeight;
    }

    function broadcastMessage(data) {
      if (!room || !isConnected) return;
      drone.publish({ room: roomName, message: data });
    }

    function insertMessageToDOM({ name, content, emoji }, mine = false) {
      const template = document.querySelector('template').content.cloneNode(true);
      template.querySelector('.message__name').textContent = `${emoji} ${name}`;
      template.querySelector('.message__bubble').textContent = content;
      const msgEl = template.querySelector('.message');
      if (mine) msgEl.classList.add('message--mine');
      document.querySelector('.messages').appendChild(template);
      scrollToBottom();
    }

    function sendChatMessage(content) {
      const messageData = { name, emoji, content: content.trim(), timestamp: Date.now() };
      insertMessageToDOM(messageData, true);
      broadcastMessage({ type: 'chat_message', message: messageData });
    }

    drone.on('open', error => {
      if (error) return alert("Connection failed");
      showStatus('Connected');
      room = drone.subscribe(roomName);
      room.on('open', err => {
        if (err) return alert("Room join failed");
        isConnected = true;
        if (isHost) broadcastState();
      });

      room.on('data', (data, client) => {
        if (client.id === drone.clientId) return;

        if (data.type === 'room_state' && !isHost) {
          if (data.locked) {
            insertSystemMessage("Room is locked. You cannot join.");
            showStatus("Access denied");
            room.unsubscribe();
            return;
          }
          const pass = prompt("Enter room passcode:");
          if (pass !== data.passcode) {
            insertSystemMessage("Wrong passcode. Access denied.");
            showStatus("Access denied");
            room.unsubscribe();
            return;
          }
          insertSystemMessage("Access granted. Welcome!");
        }

        if (data.type === 'chat_message') {
          insertMessageToDOM(data.message, false);
        }
      });
    });

    document.querySelector('form').addEventListener('submit', e => {
      e.preventDefault();
      const input = e.target.querySelector('input');
      const content = input.value.trim();
      if (!content) return;
      input.value = '';
      sendChatMessage(content);
    });
  </script>

  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
</body>
</html>
