<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üêæ Emoji Chat</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #4ECDC4;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 1.2em;
    }
    .messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 80%;
    }
    .message--mine {
      margin-left: auto;
      background: #dff9fb;
    }
    .system-message {
      text-align: center;
      font-style: italic;
      color: #888;
    }
    .message small {
      display: block;
      font-size: 0.7em;
      color: #999;
      margin-top: 5px;
    }
    footer {
      display: flex;
      padding: 10px;
      background: #fff;
    }
    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    .drag-hover {
      background: #e0f7fa;
    }
  </style>
</head>
<body>
  <header>üêæ Emoji Chat</header>
  <div class="messages"></div>
  <footer>
    <form style="flex: 1; display: flex;">
      <input type="text" placeholder="Type your message..." />
    </form>
  </footer>

  <template id="message-template">
    <div class="message">
      <strong class="name"></strong>
      <div class="bubble"></div>
    </div>
  </template>

  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <script>
    const drone = new ScaleDrone('yiS12Ts5RdNhebyM'); // Replace with your channel ID
    const GLOBAL_CHAT_ROOM = 'global-chat-room';
    const roomName = 'observable-' + (location.hash.substring(1) || GLOBAL_CHAT_ROOM);

    const emojiList = ['üê≠','üêπ','üê∂','üê±','üêª','üêº','üê∏','üêµ','ü¶ä','üêØ','üê∑','üê∞','üê®','ü¶Å','üêÆ'];
    const emoji = emojiList[Math.floor(Math.random() * emojiList.length)];
    let name = prompt("Enter your name:") || "Anonymous";
    name = name.trim() || "Anonymous";

    const messagesEl = document.querySelector('.messages');
    const form = document.querySelector('form');
    const input = document.querySelector('input[type="text"]');
    const template = document.querySelector('#message-template');
    let room;

    function addMessage({ name, content, isMine = false }) {
      const clone = template.content.cloneNode(true);
      const el = clone.querySelector('.message');
      const nameEl = clone.querySelector('.name');
      const bubble = clone.querySelector('.bubble');

      nameEl.textContent = name;
      bubble.innerHTML = content;

      if (isMine) el.classList.add('message--mine');

      const time = document.createElement('small');
      time.textContent = new Date().toLocaleTimeString();
      bubble.appendChild(time);

      messagesEl.appendChild(clone);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addSystemMessage(text) {
      const msg = document.createElement('div');
      msg.className = 'system-message';
      msg.textContent = text;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    drone.on('open', error => {
      if (error) return console.error(error);
      room = drone.subscribe(roomName);

      room.on('open', e => {
        if (e) return console.error(e);
        addSystemMessage("üü¢ Connected to chat room");
      });

      room.on('data', (data, client) => {
        if (client && client.id === drone.clientId) return;
        addMessage({ name: data.name, content: data.content });
      });
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      const msg = { name: `${emoji} ${name}`, content: text };
      addMessage({ ...msg, isMine: true });
      drone.publish({ room: roomName, message: msg });
      input.value = '';
    });

    // Drag and drop support
    const dropTarget = messagesEl;
    ['dragenter', 'dragover'].forEach(event =>
      dropTarget.addEventListener(event, e => {
        e.preventDefault();
        dropTarget.classList.add('drag-hover');
      })
    );

    ['dragleave', 'drop'].forEach(event =>
      dropTarget.addEventListener(event, () =>
        dropTarget.classList.remove('drag-hover'))
    );

    dropTarget.addEventListener('drop', e => {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files);

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result;
          const html = file.type.startsWith('image/')
            ? `<img src="${base64}" style="max-width:100%; border-radius:8px;">`
            : file.type.startsWith('video/')
            ? `<video controls style="max-width:100%; border-radius:8px;"><source src="${base64}" type="${file.type}"></video>`
            : null;

          if (html) {
            const msg = { name: `${emoji} ${name}`, content: html };
            addMessage({ ...msg, isMine: true });
            drone.publish({ room: roomName, message: msg });
          } else {
            addSystemMessage(`‚ùå Unsupported file: ${file.name}`);
          }
        };
        reader.readAsDataURL(file);
      });
    });

    // Show tips
    addSystemMessage("üí¨ Share this link to invite others");
    addSystemMessage(`You are: ${emoji} ${name}`);
  </script>
</body>
</html>
