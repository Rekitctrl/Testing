<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üêæ Emoji Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js"></script>
  <script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f2f2f2;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #4ECDC4;
      color: white;
      padding: 10px;
      text-align: center;
      font-size: 1.2em;
    }
    .messages {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      max-width: 80%;
    }
    .message--mine {
      margin-left: auto;
      background: #dff9fb;
    }
    .system-message {
      text-align: center;
      font-style: italic;
      color: #888;
    }
    .message small {
      display: block;
      font-size: 0.7em;
      color: #999;
      margin-top: 5px;
    }
    footer {
      display: flex;
      padding: 10px;
      background: #fff;
    }
    input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 20px;
      border: 1px solid #ccc;
    }
    .drag-hover {
      background: #e0f7fa;
    }
  </style>
</head>
<body>
  <header>üêæ Emoji Chat</header>
  <div class="messages"></div>
  <footer>
    <form style="flex: 1; display: flex;">
      <input type="text" placeholder="Type your message..." />
    </form>
  </footer>

  <template id="message-template">
    <div class="message">
      <strong class="name"></strong>
      <div class="bubble"></div>
    </div>
  </template>

  <script>
    const possibleEmojis = ['üêÄ','üêÅ','üê≠','üêπ','üêÇ','üêÉ','üêÑ','üêÆ','üêÖ','üêÜ','üêØ','üêá','üêê','üêë','üêè','üê¥',
      'üêé','üê±','üêà','üê∞','üêì','üêî','üê§','üê£','üê•','üê¶','üêß','üêò','üê©','üêï','üê∑','üêñ',
      'üêó','üê´','üê™','üê∂','üê∫','üêª','üê®','üêº','üêµ','üôà','üôâ','üôä','üêí','üêâ','üê≤','üêä',
      'üêç','üê¢','üê∏','üêã','üê≥','üê¨','üêô','üêü','üê†','üê°','üêö','üêå','üêõ','üêú','üêù','üêû'];
    const emoji = possibleEmojis[Math.floor(Math.random() * possibleEmojis.length)];
    let name = prompt("What's your name?").trim();
    while (!name) name = prompt("Please enter a valid name:").trim();

    const GLOBAL_CHAT_ROOM = 'global-chat-room';
    let joinCode = prompt('Enter join code (leave blank for global chat):');
    location.hash = joinCode || GLOBAL_CHAT_ROOM;
    const roomName = 'observable-' + (location.hash.substring(1) || GLOBAL_CHAT_ROOM);
    
    const drone = new ScaleDrone('yiS12Ts5RdNhebyM');
    const messagesEl = document.querySelector('.messages');
    const form = document.querySelector('form');
    const input = document.querySelector('input[type="text"]');
    const template = document.querySelector('#message-template');
    let room;
    
    const userColors = {};
    const palette = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD', '#F7DC6F', '#85C1E9'];
    let colorIndex = 0;

    function getUserColor(id) {
      if (!userColors[id]) userColors[id] = palette[colorIndex++ % palette.length];
      return userColors[id];
    }

    function addMessage({ name, content, isMine = false, clientId = null }) {
      const clone = template.content.cloneNode(true);
      const el = clone.querySelector('.message');
      const nameEl = clone.querySelector('.name');
      const bubble = clone.querySelector('.bubble');

      nameEl.textContent = name;
      if (clientId && !isMine) nameEl.style.color = getUserColor(clientId);
      bubble.innerHTML = content;

      if (isMine) el.classList.add('message--mine');

      const time = document.createElement('small');
      time.textContent = new Date().toLocaleTimeString();
      bubble.appendChild(time);

      messagesEl.appendChild(clone);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function addSystemMessage(text) {
      const msg = document.createElement('div');
      msg.className = 'system-message';
      msg.textContent = text;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    drone.on('open', error => {
      if (error) return console.error(error);
      room = drone.subscribe(roomName);

      room.on('open', err => {
        if (err) return console.error(err);
        addSystemMessage("üü¢ Connected to chat room");
        drone.publish({ room: roomName, message: { type: 'user_joined', name, emoji } });
      });

      room.on('members', members => {
        addSystemMessage(`üë• ${members.length} users online`);
      });

      room.on('member_join', () => addSystemMessage("üëã Someone joined"));
      room.on('member_leave', () => addSystemMessage("üëã Someone left"));

      room.on('data', (data, client) => {
        if (!client || client.id === drone.clientId) return;

        if (data.type === 'user_joined') {
          addSystemMessage(`${data.emoji} ${data.name} joined the chat`);
        } else if (data.compressed) {
          try {
            const decoded = atob(data.content);
            const byteArray = Uint8Array.from(decoded, c => c.charCodeAt(0));
            const decompressed = pako.inflate(byteArray, { to: 'string' });
            addMessage({ name: data.name, content: decompressed, clientId: client.id });
          } catch {
            addSystemMessage("‚ùå Error decompressing message");
          }
        } else if (data.content) {
          addMessage({ name: data.name, content: data.content, clientId: client.id });
        }
      });
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      const msg = { name: `${emoji} ${name}`, content: text };
      addMessage({ ...msg, isMine: true });
      drone.publish({ room: roomName, message: msg });
      input.value = '';
    });

    // Drag & drop
    const dropTarget = messagesEl;
    ['dragenter', 'dragover'].forEach(evt =>
      dropTarget.addEventListener(evt, e => {
        e.preventDefault();
        dropTarget.classList.add('drag-hover');
      })
    );
    ['dragleave', 'drop'].forEach(evt =>
      dropTarget.addEventListener(evt, () => dropTarget.classList.remove('drag-hover'))
    );

    dropTarget.addEventListener('drop', e => {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = () => {
          const base64 = reader.result;
          let html = '';
          if (file.type.startsWith('image/')) {
            html = `<img src="${base64}" style="max-width:100%; border-radius:8px;">`;
          } else if (file.type.startsWith('video/')) {
            html = `<video controls style="max-width:100%; border-radius:8px;"><source src="${base64}" type="${file.type}"></video>`;
          } else {
            addSystemMessage(`‚ùå Unsupported file: ${file.name}`);
            return;
          }

          const compressed = pako.deflate(html);
          const encoded = btoa(String.fromCharCode(...compressed));
          const msg = { name: `${emoji} ${name}`, content: encoded, compressed: true };
          addMessage({ name: msg.name, content: html, isMine: true });
          drone.publish({ room: roomName, message: msg });
        };
        reader.readAsDataURL(file);
      });
    });

    addSystemMessage("üí¨ Share this link to invite others");
    addSystemMessage(`You are: ${emoji} ${name}`);
  </script>
</body>
</html>
